<div class="page">
  <header class="hero">
    <div>
      <p class="eyebrow">Cadastro de consultores</p>
      <h1>Painel da API</h1>
      <p>Faça login com o usuário do Firebase e administre os dados publicados na Railway.</p>
    </div>
    <div class="hero__actions">
      <ng-container *ngIf="isAuthenticated(); else loginCta">
        <div class="hero__session">
          <small>Logado como</small>
          <strong>{{ userEmail() }}</strong>
        </div>
        <button type="button" class="btn btn--ghost" (click)="logout()">Sair</button>
        <button
          type="button"
          class="btn btn--secondary"
          (click)="loadConsultants(true)"
          [disabled]="loading()"
        >
          {{ loading() ? 'Carregando...' : 'Atualizar lista' }}
        </button>
      </ng-container>
      <ng-template #loginCta>
        <button type="button" class="btn" (click)="loginForm.markAllAsTouched()">Entre para continuar</button>
      </ng-template>
    </div>
  </header>

  <section class="panel" *ngIf="!isAuthenticated()">
    <div class="panel__header">
      <div>
        <p class="panel__eyebrow">Acesso</p>
        <h2>Login com Firebase</h2>
      </div>
    </div>

    <form [formGroup]="loginForm" (ngSubmit)="login()" class="form-grid">
      <label>
        <span>E-mail</span>
        <input type="email" placeholder="usuario@empresa.com" formControlName="email" />
        <small *ngIf="loginForm.controls.email.touched && loginForm.controls.email.invalid">
          Informe um e-mail válido.
        </small>
      </label>

      <label>
        <span>Senha</span>
        <input type="password" placeholder="Senha cadastrada no Firebase" formControlName="password" />
        <small *ngIf="loginForm.controls.password.touched && loginForm.controls.password.invalid">
          Informe a senha.
        </small>
      </label>

      <div class="form-actions">
        <button type="submit" class="btn" [disabled]="loginForm.invalid || authBusy()">
          {{ authBusy() ? 'Entrando...' : 'Entrar' }}
        </button>
      </div>
    </form>
  </section>

  <section class="panel" *ngIf="isAuthenticated()">
    <div class="panel__header">
      <div>
        <p class="panel__eyebrow">Listagem</p>
        <h2>Consultores cadastrados</h2>
      </div>
      <span class="badge">{{ filteredConsultants().length }} itens</span>
    </div>

    <div class="toolbar">
      <input
        type="search"
        placeholder="Buscar por nome, e-mail ou área"
        [value]="filterTerm()"
        (input)="onFilterChange($event)"
      />
      <button type="button" class="btn btn--ghost" (click)="loadConsultants(true)" [disabled]="loading()">
        Recarregar
      </button>
    </div>

    <div class="state" *ngIf="loading()">Carregando dados da API...</div>
    <div class="state state--muted" *ngIf="!loading() && !consultants().length">
      Nenhum consultor encontrado. Cadastre o primeiro no formulário abaixo.
    </div>

    <div class="table-wrapper" *ngIf="filteredConsultants().length">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Telefone</th>
            <th>Área</th>
            <th>Cadastro</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let consultant of filteredConsultants(); trackBy: trackById">
            <td>{{ consultant.nome }}</td>
            <td>{{ consultant.email }}</td>
            <td>{{ consultant.telefone || '—' }}</td>
            <td>{{ consultant.area || '—' }}</td>
            <td>{{ consultant.dataCadastro ? (consultant.dataCadastro | date: 'dd/MM/yyyy HH:mm') : '—' }}</td>
            <td class="table__actions">
              <button type="button" class="btn btn--ghost" (click)="editConsultant(consultant)">Editar</button>
              <button type="button" class="btn btn--danger" (click)="deleteConsultant(consultant)" [disabled]="loading()">
                Remover
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="panel" *ngIf="isAuthenticated()">
    <div class="panel__header">
      <div>
        <p class="panel__eyebrow">Formulário</p>
        <h2>{{ consultantForm.value.id ? 'Editar consultor' : 'Novo consultor' }}</h2>
      </div>
      <button type="button" class="btn btn--ghost" (click)="resetForm()">Limpar</button>
    </div>

    <form [formGroup]="consultantForm" (ngSubmit)="submitConsultant()" class="form-grid">
      <label>
        <span>Nome completo</span>
        <input type="text" placeholder="Ex: Maria Santos" formControlName="nome" />
        <small *ngIf="consultantForm.controls.nome.touched && consultantForm.controls.nome.invalid">
          Informe o nome com pelo menos 3 caracteres.
        </small>
      </label>

      <label>
        <span>E-mail</span>
        <input type="email" placeholder="maria@exemplo.com" formControlName="email" />
        <small *ngIf="consultantForm.controls.email.touched && consultantForm.controls.email.invalid">
          Informe um e-mail válido.
        </small>
      </label>

      <label>
        <span>Telefone</span>
        <input type="tel" placeholder="(11) 99999-9999" formControlName="telefone" />
      </label>

      <label>
        <span>Área de atuação</span>
        <input type="text" placeholder="Tecnologia, Marketing..." formControlName="area" />
      </label>

      <div class="form-actions">
        <button type="submit" class="btn" [disabled]="consultantForm.invalid || formBusy()">
          {{ consultantForm.value.id ? 'Atualizar consultor' : 'Cadastrar consultor' }}
        </button>
      </div>
    </form>
  </section>
</div>

<div class="toast" *ngIf="feedback()" [class.toast--error]="feedback()?.type === 'error'">
  {{ feedback()?.message }}
</div>
